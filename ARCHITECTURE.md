# ğŸ—ï¸ System Architecture - Authentication & Authorization

## ğŸ“ à¸ à¸²à¸à¸£à¸§à¸¡à¸ªà¸–à¸²à¸›à¸±à¸•à¸¢à¸à¸£à¸£à¸¡ (Architecture Overview)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Application                       â”‚
â”‚                    (Web, Mobile, Desktop)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP/HTTPS Requests
                         â”‚ Authorization: Bearer <token>
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NestJS Application                        â”‚
â”‚                     (Port 3000 - /api/*)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Global Middleware Layer                    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  1. Helmet (Security Headers)                          â”‚    â”‚
â”‚  â”‚  2. CORS (Cross-Origin Resource Sharing)               â”‚    â”‚
â”‚  â”‚  3. ValidationPipe (DTO Validation)                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Global Guards Layer                        â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  1. JwtAuthGuard (Authentication)                      â”‚    â”‚
â”‚  â”‚     - Validates JWT tokens                             â”‚    â”‚
â”‚  â”‚     - Checks @Public() decorator                       â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  2. RolesGuard (Authorization)                         â”‚    â”‚
â”‚  â”‚     - Validates user roles                             â”‚    â”‚
â”‚  â”‚     - Checks @Roles() decorator                        â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  3. ThrottlerGuard (Rate Limiting)                     â”‚    â”‚
â”‚  â”‚     - Limits requests (10 per 60s)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  Route Handlers                         â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚         Auth Module                          â”‚     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚    â”‚
â”‚  â”‚  â”‚  Controllers:                                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - AuthController                            â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ POST /auth/register                     â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ POST /auth/login                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ POST /auth/logout                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ POST /auth/refresh                      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ GET  /auth/me                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  Services:                                   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - AuthService                               â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ register()                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ login()                                 â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ logout()                                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ refreshTokens()                         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ getTokens()                             â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  Strategies:                                 â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - JwtStrategy                               â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - JwtRefreshStrategy                        â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚         Users Module                         â”‚     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚    â”‚
â”‚  â”‚  â”‚  Controllers:                                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - UsersController                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ POST   /users                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ GET    /users                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ GET    /users/:id                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ PATCH  /users/:id                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ DELETE /users/:id                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  Services:                                   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  - UsersService                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ create()                                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ findAll()                               â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ findOne()                               â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ findByEmail()                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ update()                                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    â€¢ remove()                                â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Storage Layer                          â”‚
â”‚                  (Currently: In-Memory Array)                    â”‚
â”‚                  (Future: PostgreSQL/MongoDB)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                    â”‚   NestJS     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  1. POST /auth/register                         â”‚
     â”‚  { email, password, username }                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                  â”‚
     â”‚                                    2. Validate DTO
     â”‚                                    3. Hash password (bcrypt)
     â”‚                                    4. Create user
     â”‚                                    5. Generate tokens
     â”‚                                                  â”‚
     â”‚  6. { accessToken, refreshToken }               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                  â”‚
     â”‚  7. Store tokens                                â”‚
     â”‚                                                  â”‚
     â”‚  8. POST /auth/login                            â”‚
     â”‚  { usernameOrEmail, password }                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                  â”‚
     â”‚                                    9. Find user
     â”‚                                    10. Verify password
     â”‚                                    11. Generate tokens
     â”‚                                    12. Update refresh token
     â”‚                                                  â”‚
     â”‚  13. { accessToken, refreshToken }              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                  â”‚
```

---

## ğŸ›¡ï¸ Request Authorization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                    â”‚   NestJS     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  1. GET /api/users                              â”‚
     â”‚  Authorization: Bearer <access_token>           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                  â”‚
     â”‚                                    2. ThrottlerGuard
     â”‚                                       Check rate limit
     â”‚                                                  â”‚
     â”‚                                    3. JwtAuthGuard
     â”‚                                       - Check @Public()
     â”‚                                       - Validate token
     â”‚                                       - Extract payload
     â”‚                                                  â”‚
     â”‚                                    4. RolesGuard
     â”‚                                       - Check @Roles()
     â”‚                                       - Verify user roles
     â”‚                                                  â”‚
     â”‚                                    5. Route Handler
     â”‚                                       Execute business logic
     â”‚                                                  â”‚
     â”‚  6. Response data                               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                  â”‚
```

---

## ğŸ”„ Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚                                    â”‚   NestJS     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                  â”‚
     â”‚  1. Access Token Expired                        â”‚
     â”‚                                                  â”‚
     â”‚  2. POST /auth/refresh                          â”‚
     â”‚  Authorization: Bearer <refresh_token>          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                  â”‚
     â”‚                                    3. JwtRefreshStrategy
     â”‚                                       Validate refresh token
     â”‚                                                  â”‚
     â”‚                                    4. AuthService
     â”‚                                       - Find user
     â”‚                                       - Verify stored token
     â”‚                                       - Generate new tokens
     â”‚                                       - Update refresh token
     â”‚                                                  â”‚
     â”‚  5. { accessToken, refreshToken }               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                  â”‚
     â”‚  6. Update stored tokens                        â”‚
     â”‚                                                  â”‚
```

---

## ğŸ“¦ Module Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AppModule                          â”‚
â”‚  (Root Module)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Imports:                                               â”‚
â”‚  â”œâ”€ ThrottlerModule                                     â”‚
â”‚  â”œâ”€ AuthModule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â””â”€ UsersModule            â”‚                            â”‚
â”‚                            â”‚                            â”‚
â”‚  Global Providers:         â”‚                            â”‚
â”‚  â”œâ”€ APP_GUARD: JwtAuthGuard                             â”‚
â”‚  â”œâ”€ APP_GUARD: RolesGuard  â”‚                            â”‚
â”‚  â””â”€ APP_GUARD: ThrottlerGuard                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         AuthModule                 â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                    â”‚
        â”‚  Imports:                          â”‚
        â”‚  â”œâ”€ UsersModule (for UsersService) â”‚
        â”‚  â”œâ”€ PassportModule                 â”‚
        â”‚  â””â”€ JwtModule                      â”‚
        â”‚                                    â”‚
        â”‚  Providers:                        â”‚
        â”‚  â”œâ”€ AuthService                    â”‚
        â”‚  â”œâ”€ JwtStrategy                    â”‚
        â”‚  â””â”€ JwtRefreshStrategy             â”‚
        â”‚                                    â”‚
        â”‚  Controllers:                      â”‚
        â”‚  â””â”€ AuthController                 â”‚
        â”‚                                    â”‚
        â”‚  Exports:                          â”‚
        â”‚  â””â”€ AuthService                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         UsersModule                â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                    â”‚
        â”‚  Providers:                        â”‚
        â”‚  â””â”€ UsersService                   â”‚
        â”‚                                    â”‚
        â”‚  Controllers:                      â”‚
        â”‚  â””â”€ UsersController                â”‚
        â”‚                                    â”‚
        â”‚  Exports:                          â”‚
        â”‚  â””â”€ UsersService                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Decorator Usage Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Route Handler Example                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  @Controller('admin')                                   â”‚
â”‚  export class AdminController {                         â”‚
â”‚                                                          â”‚
â”‚    @Roles(Role.ADMIN) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚    @Get('dashboard')            â”‚                       â”‚
â”‚    getDashboard(                â”‚                       â”‚
â”‚      @CurrentUser() user â”€â”€â”€â”   â”‚                       â”‚
â”‚    ) {                      â”‚   â”‚                       â”‚
â”‚      return user;           â”‚   â”‚                       â”‚
â”‚    }                        â”‚   â”‚                       â”‚
â”‚  }                          â”‚   â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚   â”‚
                              â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                            â”‚
        â–¼                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CurrentUser     â”‚                    â”‚   RolesGuard      â”‚
â”‚  Decorator       â”‚                    â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                    â”‚                   â”‚
â”‚  1. Get request  â”‚                    â”‚  1. Get metadata  â”‚
â”‚  2. Extract user â”‚                    â”‚  2. Get user      â”‚
â”‚  3. Return user  â”‚                    â”‚  3. Check roles   â”‚
â”‚     object       â”‚                    â”‚  4. Allow/Deny    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Layer 1: Network Security                              â”‚
â”‚  â”œâ”€ HTTPS (Production)                                  â”‚
â”‚  â”œâ”€ CORS Configuration                                  â”‚
â”‚  â””â”€ Helmet Security Headers                             â”‚
â”‚                                                          â”‚
â”‚  Layer 2: Rate Limiting                                 â”‚
â”‚  â”œâ”€ ThrottlerGuard                                      â”‚
â”‚  â””â”€ 10 requests per 60 seconds                          â”‚
â”‚                                                          â”‚
â”‚  Layer 3: Input Validation                              â”‚
â”‚  â”œâ”€ ValidationPipe                                      â”‚
â”‚  â”œâ”€ class-validator                                     â”‚
â”‚  â””â”€ DTO Validation                                      â”‚
â”‚                                                          â”‚
â”‚  Layer 4: Authentication                                â”‚
â”‚  â”œâ”€ JwtAuthGuard                                        â”‚
â”‚  â”œâ”€ JWT Token Validation                                â”‚
â”‚  â””â”€ Passport Strategies                                 â”‚
â”‚                                                          â”‚
â”‚  Layer 5: Authorization                                 â”‚
â”‚  â”œâ”€ RolesGuard                                          â”‚
â”‚  â””â”€ Role-Based Access Control                           â”‚
â”‚                                                          â”‚
â”‚  Layer 6: Data Security                                 â”‚
â”‚  â”œâ”€ bcrypt Password Hashing                             â”‚
â”‚  â”œâ”€ Refresh Token Hashing                               â”‚
â”‚  â””â”€ Sensitive Data Filtering                            â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DTO      â”‚  â† Validation
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller  â”‚  â† Route Handler
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service    â”‚  â† Business Logic
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Storage    â”‚  â† Data Persistence
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Response   â”‚  â† Sanitized Data
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ File Organization

```
dtam-cannabis-backend/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ auth/                    # Authentication Module
â”‚   â”‚   â”œâ”€â”€ dto/                # Data Transfer Objects
â”‚   â”‚   â”œâ”€â”€ guards/             # Auth Guards
â”‚   â”‚   â”œâ”€â”€ strategies/         # Passport Strategies
â”‚   â”‚   â”œâ”€â”€ types/              # TypeScript Types
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts  # Auth Endpoints
â”‚   â”‚   â”œâ”€â”€ auth.service.ts     # Auth Business Logic
â”‚   â”‚   â””â”€â”€ auth.module.ts      # Auth Module Config
â”‚   â”‚
â”‚   â”œâ”€â”€ users/                   # Users Module
â”‚   â”‚   â”œâ”€â”€ dto/                # User DTOs
â”‚   â”‚   â”œâ”€â”€ entities/           # User Entity
â”‚   â”‚   â”œâ”€â”€ users.controller.ts # User Endpoints
â”‚   â”‚   â”œâ”€â”€ users.service.ts    # User Business Logic
â”‚   â”‚   â””â”€â”€ users.module.ts     # User Module Config
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                  # Shared Resources
â”‚   â”‚   â”œâ”€â”€ decorators/         # Custom Decorators
â”‚   â”‚   â”œâ”€â”€ guards/             # Shared Guards
â”‚   â”‚   â””â”€â”€ enums/              # Enums
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                  # Configuration
â”‚   â”‚   â””â”€â”€ jwt.config.ts       # JWT Config
â”‚   â”‚
â”‚   â”œâ”€â”€ app.module.ts            # Root Module
â”‚   â””â”€â”€ main.ts                  # Application Entry
â”‚
â”œâ”€â”€ test/                        # Tests
â”œâ”€â”€ dist/                        # Compiled Output
â”‚
â”œâ”€â”€ AUTH_DOCUMENTATION.md        # Full Documentation
â”œâ”€â”€ QUICK_START.md               # Quick Start Guide
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md    # Implementation Summary
â”œâ”€â”€ ARCHITECTURE.md              # This File
â””â”€â”€ test-auth.http               # API Test File
```

---

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Production Setup                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚  Load Balancer â”‚                                     â”‚
â”‚  â”‚   (Nginx/ALB)  â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚           â”‚                                             â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚           â–¼          â–¼          â–¼          â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ NestJS 1 â”‚ â”‚ NestJS 2 â”‚ â”‚ NestJS 3 â”‚ â”‚ NestJS N â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚            â”‚            â”‚            â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                                    â”‚
â”‚                    â–¼                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚   Database Cluster   â”‚                       â”‚
â”‚         â”‚  (PostgreSQL/MongoDB)â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                    â”‚                                    â”‚
â”‚                    â–¼                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚         â”‚   Redis (Optional)   â”‚                       â”‚
â”‚         â”‚  Session/Cache Store â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Performance Considerations

### Bottlenecks
1. **bcrypt Hashing** - CPU intensive (10 rounds)
2. **JWT Signing** - Crypto operations
3. **Database Queries** - I/O operations

### Optimizations
1. **Async Operations** - All operations are async
2. **Promise.all** - Parallel token generation
3. **Caching** - Ready for Redis integration
4. **Stateless** - No server-side sessions

---

## ğŸ”§ Configuration Points

```
Environment Variables:
â”œâ”€â”€ PORT                    # Server port (default: 3000)
â”œâ”€â”€ NODE_ENV                # Environment (development/production)
â”œâ”€â”€ JWT_SECRET              # Access token secret
â”œâ”€â”€ JWT_REFRESH_SECRET      # Refresh token secret
â””â”€â”€ CORS_ORIGIN             # Allowed origins

Application Config:
â”œâ”€â”€ Token Expiry
â”‚   â”œâ”€â”€ Access: 15 minutes
â”‚   â””â”€â”€ Refresh: 7 days
â”œâ”€â”€ Rate Limiting
â”‚   â”œâ”€â”€ TTL: 60 seconds
â”‚   â””â”€â”€ Limit: 10 requests
â””â”€â”€ bcrypt Rounds: 10
```

---

## ğŸ¯ Key Design Decisions

### 1. Global Guards
**Decision:** Use APP_GUARD for global protection  
**Reason:** Secure by default, opt-out with @Public()

### 2. Refresh Token Rotation
**Decision:** Generate new refresh token on each refresh  
**Reason:** Enhanced security, detect token theft

### 3. In-Memory Storage
**Decision:** Use array for demo  
**Reason:** Easy to replace with real database

### 4. Role-Based Authorization
**Decision:** Enum-based roles with decorator  
**Reason:** Type-safe, easy to extend

### 5. DTO Validation
**Decision:** class-validator with transform  
**Reason:** Automatic validation and transformation

---

**Created by:** Backend Team  
**Date:** November 13, 2025  
**Version:** 1.0.0

